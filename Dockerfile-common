FROM fluent/fluentd:edge-debian

# below RUN includes plugin as examples elasticsearch is not required
# you may customize including plugins as you wish

ENV BUILD_DEPS="sudo make gcc g++ rake patch libc-dev ruby-dev zlib1g-dev libcurl4-openssl-dev libpq-dev libssl-dev libsqlite3-dev default-libmysqlclient-dev libgeoip-dev libsasl2-dev libxml2-dev"

ENV PLUGINS=" \
add \
aliyun-odps \
amazon_sns \
amplifier-filter \
amqp \
anomalydetect \
anonymizer \
assert \
aws-elasticsearch-service \
azurestorage \
beats \
better-timestamp \
bigquery \
buffered-filter \
buffer-lightening \
cadvisor \
cloudstack \
cloudwatch \
cloudwatch-ingest \
cloudwatch-logs \
cloudwatch_ya \
collectd-influxdb \
collectd-unroll \
concat \
config-expander \
copy_ex \
couch \
datacalculator \
datacounter \
dd \
dedot_filter \
df \
docker-format \
docker-journald-concat \
docker_metadata_filter \
dogstatsd \
dstat \
dynamodb \
ec2-metadata \
elasticsearch \
elasticsearch-timestamp-check \
elb-access-log \
elb-log \
esslowquery \
eval-filter \
eventcounter \
eventlastvalue \
exclude-filter \
extract_query_params \
fields-parser \
file-alternative \
file-sprintf \
filter \
filter-geoip \
filter-parse-postfix \
filter-record-map \
filter_typecast \
flatten \
flatten-hash \
flowcounter \
flowcounter-simple \
flume \
forest \
formatter_sprintf \
forward-aws \
gcloud-pubsub-custom \
geoblipper \
geoip \
google-cloud \
graphite \
grassland \
grep \
grepcounter \
grok-parser \
groonga \
growthforecast \
hash-forward \
hipchat \
histogram \
hoop \
ignore-filter \
ikachan \
influxdb \
irc \
json-in-json \
jsonish \
json-nest2flat \
json-parser \
kafka \
keep-forward \
kinesis \
kinesis-aggregation \
kubernetes \
kubernetes_metadata_filter \
kv-parser \
logentries \
loggly \
logzio \
ltsv-parser \
mackerel \
mail \
map \
mesosphere-filter \
metricsense \
mixpanel \
mongo \
mongo-slow-query \
mqtt-io \
multi-format-parser \
multiprocess \
munin \
mutate_filter \
mysql \
mysql-appender \
mysql-query \
mysql-replicator \
netflow \
newsyslog \
norikra \
notifier \
nsq \
numeric-counter \
numeric-monitor \
out-http \
output-solr \
parser \
pghstore \
pgjson \
ping-message \
prometheus \
qqwry \
rds-log \
rds-slowlog \
reassemble \
record-modifier \
record-reformer \
redis \
redis-counter \
reemit \
referer-parser \
remote_syslog \
rename-key \
retag \
rewrite \
rewrite-tag-filter \
route \
s3 \
sampling-filter \
scribe \
script \
secure-forward \
select \
slack \
snmp \
sns \
splunkapi \
sql \
sqs \
sqs-poll \
stats \
statsd \
sumologic-cloud-syslog \
sumologic_output \
suppress \
systemd \
tai64n_parser \
td \
td-monitoring \
text_to_json \
time_parser \
twilio \
twitter \
typecast \
typetalk \
ua-parser \
unit-time-filter \
viaq_data_model \
webhdfs \
woothee \
xml-simple-filter \
yohoushi \
zabbix \
zabbix-simple-bufferd \
"

RUN set -ex; \
   sed -r -i -e 's! main! main contrib non-free!g' /etc/apt/sources.list; \
   cat /etc/apt/sources.list ; \
   apt-get update -q; \
   apt-cache search '.*mysql.*-dev' ; \
   apt-get install -qy --no-install-recommends $BUILD_DEPS; \
   for name in $PLUGINS; do gem install "fluent-plugin-$name"; done; \
   gem sources --clear-all; \
   apt-get purge -qy $(dpkg-query --show --showformat '${Package}\n' '*-dev'); \
   rm -rf /var/lib/apt/lists/* /home/fluent/.gem/ruby/*/cache/*.gem
